This is my preferred setup when it comes to creating
Java web applications. It handles several issues.

This is an early version and used for preparing for
my JavaZone 2009 talk on Agile Deployment. In it's current
state I guess it is best suited for inspiration.

You can find the the talks here (Norwegian only):
* Slides: http://www.slideshare.net/anderssv/javazone2009-smidig-utrulling
* Video: http://tcs.java.no/tcs/?id=2E72A3F8-CD11-4C5C-A29A-63EB3E95149F

It is loosely based around the following articles:

* http://www.infoq.com/articles/deployment-is-the-goal
* http://blog.f12.no/wp/2009/03/27/agile-deployment-talk-retro/
* http://blog.f12.no/wp/2009/07/08/java-migrations-tools/
* http://blog.f12.no/wp/2009/01/24/the-new-guy-and-his-database/
* http://blog.f12.no/wp/2009/01/03/migrations-for-java/

h1. Pre requisites 

Installed:

* Maven
* Java

h2. Compiling

To compile you must add a repository to your <code>~/.m2/settings.xml</code>:

<pre><code>
 	<profile>
		<id>extra-repo</id>
		<activation>
			<activeByDefault>true</activeByDefault>
		</activation>
		<repositories>
			<repository>
				<id>dbdeploy</id>
				<url>http://dbdeploy.googlecode.com/svn/m2-repo/repository/</url>
			</repository>
		</repositories>
	</profile>
</code></pre>

After that just run <code>mvn clean install</code> and find the jar in the target directory.

h2. Configuration

To use the deployer you need a Maven repository. So far, only http
repositories are supported. See below for instructions on setting the
repository that will be used.

h1. How to use

If you understand Maven it will be a lot easier to figure this out. :)

h2. Application template

The template is meant to be an example of how to create a light weight 
application with Jetty embedded. It is packaged as a ZIP, with .jar 
files included as well as some scripts to start the application. This is 
achieved by using the Maven app-assembler and assembly plugin. Have a 
look inside the target folder and the ZIP to figure out what is 
happening. 

You can use this for most web applications. In my opinion you really 
don't need a big app server most of the time. A future version might
include an embedded version of Tomcat.

For most projects where you're tied to the application server the current
state of the project and deployer might suit your needs for batches.
I hope to develop more methods for deployment.

This would be suitable for a Maven Archetype, but I didn't find any good 
information on creating a multi project archetype. I'll have to look 
into it later. 

h2. Deployer

The deployer is packaged as a JAR with a manifest that says which class 
to execute. To launch the deployer, package it with Maven and use the JAR.
Enter the following on the command line: 

<pre>java -jar deployer-0.1-SNAPSHOT.jar <env> <groupId> <artifactId> <version></pre>

By default it downloads artifacts from the Maven repository 
(http://repo1.maven.org/maven2), but you can change this in a property 
file called deploy.properties . By placing this file in the directory 
you are running the JAR from, and adding a property like below you can 
change the repo. 

NOTE So far this only supports http based repositories.

h3. Configuration

Place a file called deploy.properties in the directory your are executing from
The following are the valid parameters:

|_. Property |_. Description |
| repo.url | The full URL to the repository containing releases. |
| repo.snapshot.url | The full URL to the repository containing SNAPSHOT releases. |
| conversion.encoding.source | When deploying to systems with different encoding than 
your origin you might want to convert script and settings files to the platform 
encoding. If this setting is set the deployer will read the files in with this encoding
and write with target. |
| conversion.encoding.target | The target encoding to write files with |
| conversion.paths | The paths to do conversion for. Multiple paths are separated
by ; . Note that these paths must only contain text files. |

h3. DBDeploy

To use DBDeploy with the deployer you must include a datasource.properties
in your application. This is handled as regular for deployment, but DBDeploy
will look in the "current" directory for this file. See the example file
in the application template for the necessary settings.

h3. What it does

The deployer handles some basic things:
* Downloading
* Unpacking
* Finding the correct properties
* Symlinking necessary directories

In detail the deployer performs the following tasks:
* Downloads the specified artifact from the Maven repo
* Unpacks the zip into <code><artifactId>/<env>/current</code>
* Copies settings (if they don't exist, no overwriting) from 
  <pre><code>
  <artifactId>/<env>/current/properties and 
  <artifactId>/<env>/current/properties/<env> into
  <artifactId>/<env>
  </code></pre>
* Converts text files from one encoding to another
* Creates symlink from <code><artifactId>/<env>/*.properties</code> into
  <code><artifactId>/<env>/current</code> (copy if not symlink capable)
* Creates symlink from <code><artifactId>/<env>/data</code> into
  <code><artifactId>/<env>/current</code>

h1. Tasks and features

h2. DONE

* Packaging the application with all dependencies into
** A war
** A zip with all required JARs and WARs
* Installing
** Download release
** Unpacking
** Download snapshot
** Installing configuration
* Issues with clean up after run of deployer, some directories can not be deleted
* Default config for all environments, can be overrided by env
* Data directory in the environment dir that is not deleted on redeploy
* Sym link to data directory
* Copy files to env dir and sym link to current
* Correct permissions on execute scripts
* Upgrading the database
* Converting encoding of scripts and config
* Separate SNAPSHOT and release repo

h2. TODO

h2. FUTURE

* Start/stop scripts
* Merge in new settings in properties files into existing file on disk?
* Run with daemon? JSW might have licence issues
* Other options for executing DB script?
* Recommended practices
* Support for file based repositories?
* Maven archetype for the template. Don't know how to create one for a project
  with two subprojects.
* Clean up exception handling. Way too many IllegalStateExceptions
* Separate log config for tests
* Stop before deploy
* Start after deploy 

h1. Finally

Some of these parts should probably be in something like Scala or JRuby, 
but I'll have to take the time to learn that later. :) 



-- Anders Sveen <anders@f12.no>
