This is my preferred setup when it comes to creating
Java web applications. It handles several issues.

This is an early version and used for preparing for
my JavaZone 2009 talk on Agile Deployment. In it's current
state I guess it is best suited for inspiration.

It is loosely based around the following articles:

* http://blog.f12.no/wp/2009/03/27/agile-deployment-talk-retro/
* http://blog.f12.no/wp/2009/07/08/java-migrations-tools/
* http://blog.f12.no/wp/2009/01/24/the-new-guy-and-his-database/
* http://blog.f12.no/wp/2009/01/03/migrations-for-java/
* http://www.infoq.com/articles/deployment-is-the-goal

h1. Pre requisites 

Installed:

* Maven
* Java

h2. Compiling

To compile you must add a repository to your ~/.m2/settings.xml:

pre. 	<profile>
		<id>extra-repo</id>
		<activation>
			<activeByDefault>true</activeByDefault>
		</activation>
		<repositories>
			<repository>
				<id>dbdeploy</id>
				<url>http://dbdeploy.googlecode.com/svn/m2-repo/repository/</url>
			</repository>
		</repositories>
	</profile>

After that just run "mvn clean install" and find the jar in the target directory.

h2. Configuration

To use the deployer you need a Maven repository. So far, only http
repositories are supported. See below for instructions on setting the
repository.

h1. How to use

If you understand Maven it will be a lot easier to figure this out. :)

h2. Application template

The template is meant to be an example of how to create a light weight 
application with Jetty embedded. It is packaged as a ZIP, with .jar 
files included as well as some scripts to start the application. This is 
achieved by using the Maven app-assembler and assembly plugin. Have a 
look inside the target folder and the ZIP to figure out what is 
happening. 

You can use this for most webapplications. In my opinion you really 
don't need a big app server most of the time. A future version might
include an embedded version og Tomcat.

This would be suitable for a Maven Archetype, but I didn't find any good 
information on creating a multi project archetype. I'll have to look 
into it later. 

h2. Deployer

The deployer is packaged as a JAR with a manifest that says which class 
to execute. To launch the deployer enter the following on the command 
line: 

pre. java -jar deployer-0.1-SNAPSHOT.jar <env> <groupId> <artifactId> <version> 

By default it downloads artifacts from the Maven repository 
(http://repo1.maven.org/maven2), but you can change this in a property 
file called deploy.properties . By placing this file in the directory 
you are running the JAR from, and adding a property like below you can 
change the repo. 

pre. repo.url=http://myrepo.myorg.com/maven2/ 

NOTE So far this only supports http based repositories.

h3. DBDeploy

To use DBDeploy with the deployer you must include a datasource.properties
in your application. This is handled as regular for deployment, but DBDeploy
will look in the "current" directory for this file. See the example file
in the application template for the necessary settings.

h3. What it does

The deployer handles some basic things:
* Unpacking
* Finding the correct properties
* Symlinking necessary directories

In detail the deployer performs the following tasks:
* Downloads the specified artifact from the Maven repo
* Unpacks the zip into bq. <artifactId>/<env>/current
* Copies settings (if they don't exist, no overwriting) from 
  bq. <artifactId>/<env>/current/properties and 
  <artifactId>/<env>/current/properties/<env> into
  <artifactId>/<env>
* Creates symlink from <artifactId>/<env>/*.properties into
  bq. <artifactId>/<env>/current (copy if not symlink capable)
* Creates symlink from <artifactId>/<env>/data into
  bq. <artifactId>/<env>/current

h1. Tasks and features

h2. DONE

* Packaging the application with all dependencies into
** A war
** A zip with all required JARs and WARs
* Installing
** Download release
** Unpacking
** Download snapshot
** Installing configuration
* Issues with clean up after run of deployer, some directories can not be deleted
* Default config for all environments, can be overrided by env
* Data directory in the environment dir that is not deleted on redeploy
* Sym link to data directory
* Copy files to env dir and sym link to current
* Correct permissions on execute scripts
* Upgrading the database

h2. TODO

h2. FUTURE

* Start/stop scripts
* Merge in new settins in properties files into existing file on disk?
* Run with daemon? JSW might have licence issues
* Other options for executing DB script?
* Recommended practices
* Separate SNAPSHOT and release repo
* Support for file based repositories?
* Maven archetype for the template. Don't know how to create one for a project
  with two subprojects.
* Clean up exception handling. Way too many IllegalStateExceptions
* Separate log config for tests
* Stop before deploy
* Start after deploy 

h1. Finally

Some of these parts should probably be in something like Scala or JRuby, 
but I'll have to take the time to learn that later. :) 



-- Anders Sveen <anders@f12.no>
